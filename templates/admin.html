<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        
        .input-with-button input {
            flex: 1;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .lecture-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .lecture-item input {
            margin-bottom: 10px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .header-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px 25px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-bar h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-logout {
            background: rgba(255, 68, 68, 0.3);
            border: 1px solid rgba(255, 68, 68, 0.5);
        }
        
        .btn-logout:hover {
            background: rgba(255, 68, 68, 0.5);
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            max-width: 400px;
            margin: 20px;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .nav-links {
            text-align: center;
            margin-top: 20px;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-size: 18px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: inline-block;
            transition: background 0.3s;
        }
        
        .nav-links a:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <h1>‚úàÔ∏è Dashboard Configuration</h1>
            <div class="header-actions">
                <button class="btn btn-small" onclick="showPasswordModal()">üîë Change Password</button>
                <button class="btn btn-small btn-logout" onclick="logout()">üö™ Logout</button>
            </div>
        </div>
        
        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-error" id="errorAlert"></div>
        
        <!-- Password Change Modal -->
        <div id="passwordModal" class="modal-overlay">
            <div class="card modal-content">
                <h2>Change Password</h2>
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
                    <button class="btn btn-secondary" onclick="hidePasswordModal()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Display Settings -->
        <div class="card">
            <h2>üé® Display Settings</h2>
            <div class="form-group">
                <label for="fontScale">Font Size Scale</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="range" id="fontScale" min="0.7" max="1.5" step="0.05" value="1.0" style="flex: 1;">
                    <span id="fontScaleValue" style="min-width: 50px; font-weight: bold;">100%</span>
                </div>
                <div class="help-text">
                    Adjust the size of all text on the display. Default is 100%.<br>
                    Range: 70% (smaller) to 150% (larger)
                </div>
            </div>
        </div>
        
        <!-- Location Settings -->
        <div class="card">
            <h2>üìç Location Settings</h2>
            <div class="grid">
                <div class="form-group">
                    <label for="locationSearch">üîç Search by City or Address</label>
                    <div class="input-with-button">
                        <input type="text" id="locationSearch" placeholder="e.g., Frankfurt Airport, Germany">
                        <button class="btn btn-info btn-small" onclick="searchLocation()">Search</button>
                    </div>
                    <div class="help-text">Enter any city, airport, or address to auto-fill coordinates</div>
                </div>
                
                <div class="form-group">
                    <label for="locationName">Location Name</label>
                    <input type="text" id="locationName" placeholder="e.g., Frankfurt">
                </div>
                <div class="form-group">
                    <label for="latitude">Latitude</label>
                    <input type="number" id="latitude" step="0.0001" placeholder="e.g., 50.1109">
                    <div class="help-text">Used for weather and flight tracking</div>
                </div>
                <div class="form-group">
                    <label for="longitude">Longitude</label>
                    <input type="number" id="longitude" step="0.0001" placeholder="e.g., 8.6821">
                </div>
                <button class="btn btn-secondary" onclick="getCurrentLocation()">üìç Use My Current Location (HTTPS only)</button>
                <div id="locationResult"></div>
            </div>
        </div>
        
        <!-- Weather Settings -->
        <div class="card">
            <h2>üå§Ô∏è Weather Settings</h2>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="weatherEnabled">
                <label for="weatherEnabled">Enable Weather Display</label>
            </div>
            <div class="form-group">
                <label for="weatherApiKey">OpenWeatherMap API Key</label>
                <div class="input-with-button">
                    <input type="text" id="weatherApiKey" placeholder="Get free API key from openweathermap.org">
                    <button class="btn btn-info btn-small" onclick="testWeatherAPI()">üß™ Test API</button>
                </div>
                <div class="help-text">
                    Sign up at <a href="https://openweathermap.org/api" target="_blank">openweathermap.org/api</a><br>
                    ‚úÖ Works with both FREE "Current Weather Data" API and "One Call API 3.0" (1,000 calls/day free)
                </div>
                <div class="test-result" id="weatherTestResult"></div>
            </div>
        </div>
        
        <!-- AirLabs Flight Tracking -->
        <div class="card">
            <h2>‚úàÔ∏è Flight Tracking</h2>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="airlabsEnabled" checked>
                <label for="airlabsEnabled">Enable Nearby Flights List</label>
            </div>
            
            <div class="form-group">
                <label for="flightApiProvider">API Provider</label>
                <select id="flightApiProvider" onchange="toggleFlightApiSettings()">
                    <option value="airplaneslive">Airplanes.live (free, unlimited)</option>
                </select>
                <div class="help-text">
                    ‚úÖ Unlimited real-time flight data with no API key required<br>
                    üìç Route information (airports) cached and learned over time
                </div>
            </div>
            
            <div class="form-group">
                <label for="airlabsRadius">Search Radius (km)</label>
                <input type="number" id="airlabsRadius" value="75" min="10" max="200" step="5">
                <div class="help-text">How far to search for nearby flights (default: 75km)</div>
            </div>
            
            <div class="form-group">
                <h3>üåê OpenSky Network - Automatic Route Discovery</h3>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="openskyEnabled" checked>
                    <label for="openskyEnabled">Enable automatic route lookup</label>
                </div>
                <p class="help-text">
                    OpenSky Network provides historical flight data to automatically discover routes.<br>
                    <strong>Free tier:</strong> 4,000 API credits/day (anonymous) or 8,000/day (with account)<br>
                    Routes are cached for efficiency - only unknown flights trigger API lookups.
                </p>
                
                <div class="form-group">
                    <label for="openskyClientId">OpenSky API Client ID (Optional)</label>
                    <input type="text" id="openskyClientId" placeholder="Leave empty for anonymous access (400 credits/day)">
                    <div class="help-text">
                        <strong>To get credentials:</strong><br>
                        1. Create account at <a href="https://opensky-network.org/register" target="_blank">opensky-network.org</a><br>
                        2. Go to <a href="https://opensky-network.org/my-opensky/account" target="_blank">Account page</a><br>
                        3. Create new API Client and copy Client ID<br>
                        <strong>Benefits:</strong> 4,000-8,000 credits/day (vs 400 anonymous)
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="openskyClientSecret">OpenSky API Client Secret (Optional)</label>
                    <div class="input-with-button">
                        <input type="password" id="openskyClientSecret" placeholder="Leave empty for anonymous access">
                        <button class="btn btn-info btn-small" onclick="testOpenskyAPI()">üß™ Test API</button>
                    </div>
                    <div class="help-text">Copy from API Client page - keep this secret!</div>
                    <div class="test-result" id="openskyTestResult"></div>
                </div>
                
                <div class="form-group">
                    <label for="cacheExpiry">Cache Expiry (days)</label>
                    <input type="number" id="cacheExpiry" value="7" min="1" max="90" step="1">
                    <div class="help-text">How many days to keep cached routes before refreshing (default: 7 days)</div>
                </div>
            </div>
            
            <div class="form-group">
                <h3>üõ´ AirLabs - Route Discovery Fallback</h3>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="airlabsRouteEnabled" checked>
                    <label for="airlabsRouteEnabled">Enable AirLabs route fallback</label>
                </div>
                <p class="help-text">
                    AirLabs provides route data when OpenSky doesn't find results.<br>
                    <strong>Free tier:</strong> 1,000 API calls/month (~33/day)<br>
                    Only queries when OpenSky returns no route - maximizes coverage while conserving API quota.
                </p>
                
                <div class="form-group">
                    <label for="airlabsApiKey">AirLabs API Key</label>
                    <div class="input-with-button">
                        <input type="password" id="airlabsApiKey" placeholder="Enter your AirLabs API key">
                        <button class="btn btn-info btn-small" onclick="testAirlabsAPI()">üß™ Test API</button>
                    </div>
                    <div class="help-text">
                        <strong>To get API key:</strong><br>
                        1. Sign up at <a href="https://airlabs.co/" target="_blank">airlabs.co</a><br>
                        2. Go to <a href="https://airlabs.co/dashboard" target="_blank">Dashboard</a><br>
                        3. Copy your API Key<br>
                        <strong>Benefits:</strong> Fills gaps when OpenSky has no route data
                    </div>
                    <div class="test-result" id="airlabsTestResult"></div>
                </div>
            </div>
        </div>
        
        <!-- Transport Settings -->
        <div class="card">
            <h2>üöå Public Transport Settings (TRIAS API)</h2>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="transportEnabled" checked>
                <label for="transportEnabled">Enable Transport Display</label>
            </div>
            <p class="help-text">
                Using TRIAS API (Austrian public transit) - no API key required<br>
                Search for your stop by name to get real-time departures
            </p>
            
            <div class="form-group">
                <label for="transportStopSearch">Search for Stop</label>
                <div class="input-with-button">
                    <input type="text" id="transportStopSearch" placeholder="Enter stop name (e.g., Alte Poststra√üe)">
                    <button class="btn btn-info btn-small" onclick="searchTransitStops()">üîç Search</button>
                </div>
                <div class="help-text">Type at least 2 characters and click Search</div>
            </div>
            
            <div class="form-group" id="stopSearchResults" style="display: none;">
                <label>Search Results (click to select):</label>
                <div id="stopsList" style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 5px;"></div>
            </div>
            
            <div class="form-group">
                <label for="transportStopName">Selected Stop</label>
                <input type="text" id="transportStopName" placeholder="No stop selected" readonly>
            </div>
            
            <div class="form-group">
                <label for="transportStopId">Stop ID</label>
                <div class="input-with-button">
                    <input type="text" id="transportStopId" placeholder="Stop ID (from search)" readonly>
                    <button class="btn btn-info btn-small" onclick="testTransportAPI()">üß™ Test</button>
                </div>
                <div class="test-result" id="transportTestResult"></div>
            </div>
        </div>
        
        <!-- Timetable Settings -->
        <div class="card">
            <h2>üìÖ Lecture Timetable (FH JOANNEUM Almaty)</h2>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="timetableEnabled" checked>
                <label for="timetableEnabled">Enable Timetable Display</label>
            </div>
            <p class="help-text">
                Using FH JOANNEUM Almaty timetable API - no API key required<br>
                Automatically shows all year groups: LAV23, LAV24, LAV25, MAV25
            </p>
            
            <div class="form-group">
                <label for="timetableCohort">Filter by Cohort (Optional)</label>
                <input type="text" id="timetableCohort" placeholder="Leave empty for all cohorts, or enter LAV2023, MAV2025, etc.">
                <div class="help-text">
                    <strong>Leave empty to show all year groups automatically.</strong><br>
                    Or enter a specific cohort to filter (e.g., "LAV2023" or "LAV 2023")
                </div>
            </div>
            
            <div class="form-group">
                <label for="timetableMaxItems">Maximum Items to Display: <span id="timetableMaxValue">5</span></label>
                <input type="range" id="timetableMaxItems" min="3" max="15" value="5" step="1" 
                       oninput="document.getElementById('timetableMaxValue').textContent = this.value">
                <div class="help-text">Number of upcoming lectures to show (3-15)</div>
            </div>
            
            <div class="form-group">
                <label for="timetableTimeWindow">Time Window (Hours)</label>
                <input type="number" id="timetableTimeWindow" min="1" max="168" value="24" step="1">
                <div class="help-text">Only show lectures within this many hours from now (1-168 hours = up to 7 days)</div>
            </div>
            
            <button class="btn btn-secondary" onclick="testTimetableAPI()">üß™ Test Timetable API</button>
            <div class="test-result" id="timetableTestResult"></div>
        </div>
        
        <!-- Save Button -->
        <div class="btn-group">
            <button class="btn btn-primary" onclick="saveConfig()">üíæ Save Configuration</button>
        </div>
        
        <div class="nav-links">
            <a href="/">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <script>
        // Load configuration on page load
        async function loadConfig() {
            try {
                const response = await fetch('/api/dashboard/config');
                const data = await response.json();
                
                if (data.success) {
                    const config = data.config;
                    
                    // Display
                    const fontScale = config.display?.font_scale || 1.0;
                    document.getElementById('fontScale').value = fontScale;
                    document.getElementById('fontScaleValue').textContent = Math.round(fontScale * 100) + '%';
                    
                    // Location
                    document.getElementById('locationName').value = config.location?.name || '';
                    document.getElementById('latitude').value = config.location?.lat || '';
                    document.getElementById('longitude').value = config.location?.lon || '';
                    
                    // Weather
                    document.getElementById('weatherEnabled').checked = config.weather?.enabled || false;
                    document.getElementById('weatherApiKey').value = config.weather?.api_key || '';
                    
                    // AirLabs
                    document.getElementById('airlabsEnabled').checked = config.airlabs?.enabled !== false;
                    document.getElementById('flightApiProvider').value = config.airlabs?.api_provider || 'airplaneslive';
                    document.getElementById('airlabsRadius').value = config.airlabs?.radius_km || 75;
                    toggleFlightApiSettings();
                    
                    // OpenSky
                    document.getElementById('openskyEnabled').checked = config.opensky?.enabled !== false;
                    document.getElementById('openskyClientId').value = config.opensky?.client_id || '';
                    document.getElementById('openskyClientSecret').value = config.opensky?.client_secret || '';
                    document.getElementById('cacheExpiry').value = config.opensky?.cache_days || 7;
                    
                    // AirLabs Route
                    document.getElementById('airlabsRouteEnabled').checked = config.airlabs_route?.enabled !== false;
                    document.getElementById('airlabsApiKey').value = config.airlabs_route?.api_key || '';
                    
                    // Transport
                    document.getElementById('transportEnabled').checked = config.transport?.enabled !== false;
                    document.getElementById('transportStopId').value = config.transport?.stop_id || '';
                    document.getElementById('transportStopName').value = config.transport?.stop_name || '';
                    
                    // Timetable
                    document.getElementById('timetableEnabled').checked = config.timetable?.enabled !== false;
                    document.getElementById('timetableCohort').value = config.timetable?.cohort || '';
                    const maxItems = config.timetable?.max_items || 5;
                    document.getElementById('timetableMaxItems').value = maxItems;
                    document.getElementById('timetableMaxValue').textContent = maxItems;
                    const timeWindow = config.timetable?.time_window_hours || 24;
                    document.getElementById('timetableTimeWindow').value = timeWindow;
                }
            } catch (error) {
                showError('Failed to load configuration: ' + error.message);
            }
        }
        
        // Save configuration
        async function saveConfig() {
            try {
                const config = {
                    display: {
                        font_scale: parseFloat(document.getElementById('fontScale').value) || 1.0
                    },
                    location: {
                        name: document.getElementById('locationName').value,
                        lat: parseFloat(document.getElementById('latitude').value) || 0,
                        lon: parseFloat(document.getElementById('longitude').value) || 0
                    },
                    weather: {
                        enabled: document.getElementById('weatherEnabled').checked,
                        api_key: document.getElementById('weatherApiKey').value
                    },
                    airlabs: {
                        enabled: document.getElementById('airlabsEnabled').checked,
                        api_provider: document.getElementById('flightApiProvider').value,
                        radius_km: parseInt(document.getElementById('airlabsRadius').value) || 75
                    },
                    opensky: {
                        enabled: document.getElementById('openskyEnabled').checked,
                        client_id: document.getElementById('openskyClientId').value,
                        client_secret: document.getElementById('openskyClientSecret').value,
                        cache_days: parseInt(document.getElementById('cacheExpiry').value) || 7
                    },
                    airlabs_route: {
                        enabled: document.getElementById('airlabsRouteEnabled').checked,
                        api_key: document.getElementById('airlabsApiKey').value
                    },
                    transport: {
                        enabled: document.getElementById('transportEnabled').checked,
                        api_type: 'trias',
                        stop_id: document.getElementById('transportStopId').value,
                        stop_name: document.getElementById('transportStopName').value
                    },
                    timetable: {
                        enabled: document.getElementById('timetableEnabled').checked,
                        cohort: document.getElementById('timetableCohort').value,
                        max_items: parseInt(document.getElementById('timetableMaxItems').value) || 5,
                        time_window_hours: parseInt(document.getElementById('timetableTimeWindow').value) || 24
                    }
                };
                
                const response = await fetch('/api/dashboard/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Configuration saved successfully!');
                } else {
                    showError('Failed to save: ' + data.message);
                }
            } catch (error) {
                showError('Error saving configuration: ' + error.message);
            }
        }
        
        // Add new lecture
        // Show success message
        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }
        
        // Show error message
        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        // Test weather API
        async function testWeatherAPI() {
            const apiKey = document.getElementById('weatherApiKey').value;
            const lat = parseFloat(document.getElementById('latitude').value) || 50.0;
            const lon = parseFloat(document.getElementById('longitude').value) || 8.0;
            const resultDiv = document.getElementById('weatherTestResult');
            
            if (!apiKey) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Please enter an API key first';
                resultDiv.style.display = 'block';
                return;
            }
            
            // Trim whitespace from API key
            const trimmedKey = apiKey.trim();
            if (trimmedKey !== apiKey) {
                document.getElementById('weatherApiKey').value = trimmedKey;
            }
            
            resultDiv.className = 'test-result';
            resultDiv.textContent = '‚è≥ Testing API... (This may take a few seconds)';
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch(`/api/test/weather?api_key=${encodeURIComponent(trimmedKey)}&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `‚úÖ <strong>API working!</strong><br>Temperature: ${data.temp}¬∞C<br>${data.description}<br>Location: ${data.location}`;
                } else {
                    resultDiv.className = 'test-result error';
                    if (response.status === 401) {
                        resultDiv.innerHTML = `‚ùå <strong>${data.message}</strong><br><br>
                            <strong>Troubleshooting:</strong><br>
                            1. If you just created the key, wait 10-15 minutes and try again<br>
                            2. Copy the key from <a href="https://home.openweathermap.org/api_keys" target="_blank">your API keys page</a><br>
                            3. Key length: ${trimmedKey.length} characters (should be 32)<br>
                            4. Make sure the API key is activated in your account`;
                    } else {
                        resultDiv.textContent = `‚ùå ${data.message}`;
                    }
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Connection error: ${error.message}`;
            }
        }
        
        // Add route to cache
        async function addRouteToCache() {
            const callsign = document.getElementById('routeCallsign').value.trim().toUpperCase();
            const from = document.getElementById('routeFrom').value.trim().toUpperCase();
            const to = document.getElementById('routeTo').value.trim().toUpperCase();
            const resultDiv = document.getElementById('routeCacheResult');
            
            if (!callsign) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Please enter a flight callsign';
                resultDiv.style.display = 'block';
                return;
            }
            
            if (!from && !to) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Please enter at least one airport (from or to)';
                resultDiv.style.display = 'block';
                return;
            }
            
            resultDiv.className = 'test-result';
            resultDiv.textContent = '‚è≥ Adding route...';
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/flight-routes/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ callsign, from, to })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `‚úÖ ${data.message}<br>Cache now contains ${data.cache_size} route(s)`;
                    
                    // Clear inputs
                    document.getElementById('routeCallsign').value = '';
                    document.getElementById('routeFrom').value = '';
                    document.getElementById('routeTo').value = '';
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = `‚ùå ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        // Toggle flight API settings visibility
        function toggleFlightApiSettings() {
            // Currently only airplanes.live is available, so nothing to toggle
            // Function kept for future compatibility
        }
        
        // Test OpenSky API
        async function testOpenskyAPI() {
            const clientId = document.getElementById('openskyClientId').value.trim();
            const clientSecret = document.getElementById('openskyClientSecret').value.trim();
            const resultDiv = document.getElementById('openskyTestResult');
            
            if (!clientId && !clientSecret) {
                resultDiv.className = 'test-result';
                resultDiv.innerHTML = '‚è≥ Testing anonymous access...';
                resultDiv.style.display = 'block';
            } else if (!clientId || !clientSecret) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Please provide both Client ID and Client Secret, or leave both empty for anonymous access';
                resultDiv.style.display = 'block';
                return;
            } else {
                resultDiv.className = 'test-result';
                resultDiv.innerHTML = '‚è≥ Testing API credentials...';
                resultDiv.style.display = 'block';
            }
            
            try {
                const params = new URLSearchParams();
                if (clientId) params.append('client_id', clientId);
                if (clientSecret) params.append('client_secret', clientSecret);
                
                const response = await fetch(`/api/test/opensky?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `‚úÖ <strong>API working!</strong><br>${data.message}<br>Credits: ${data.credits || 'N/A'}`;
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = `‚ùå ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Connection error: ${error.message}`;
            }
        }
        
        // Test AirLabs API
        async function testAirlabsAPI() {
            const apiKey = document.getElementById('airlabsApiKey').value.trim();
            const resultDiv = document.getElementById('airlabsTestResult');
            
            if (!apiKey) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Please enter an API key';
                resultDiv.style.display = 'block';
                return;
            }
            
            resultDiv.className = 'test-result';
            resultDiv.innerHTML = '‚è≥ Testing API key...';
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch(`/api/test/airlabs?api_key=${encodeURIComponent(apiKey)}`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `‚úÖ <strong>API working!</strong><br>${data.message}`;
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = `‚ùå ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Connection error: ${error.message}`;
            }
        }
        
        // Test transport API
        async function searchTransitStops() {
            const query = document.getElementById('transportStopSearch').value;
            const resultsDiv = document.getElementById('stopSearchResults');
            const stopsList = document.getElementById('stopsList');
            
            if (!query || query.length < 2) {
                alert('Please enter at least 2 characters');
                return;
            }
            
            try {
                stopsList.innerHTML = '<div style="padding: 10px;">‚è≥ Searching...</div>';
                resultsDiv.style.display = 'block';
                
                const response = await fetch(`/api/transport/search-stops?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success && data.stops.length > 0) {
                    stopsList.innerHTML = data.stops.map(stop => {
                        const stopDataJson = JSON.stringify(stop).replace(/"/g, '&quot;');
                        return `
                        <div style="padding: 8px; margin: 2px; background: rgba(255,255,255,0.1); border-radius: 4px; cursor: pointer; transition: background 0.2s;" 
                             onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                             onmouseout="this.style.background='rgba(255,255,255,0.1)'"
                             onclick='selectStop(${stopDataJson})'>
                            <strong>${stop.stop_name}</strong><br>
                            <small style="opacity: 0.7;">Primary ID: ${stop.stop_id}</small>
                        </div>
                    `}).join('');
                } else {
                    stopsList.innerHTML = '<div style="padding: 10px; opacity: 0.7;">No stops found. Try a different search term.</div>';
                }
            } catch (error) {
                stopsList.innerHTML = `<div style="padding: 10px; color: #ff4444;">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function selectStop(stopData) {
            // Clean up the stop name (remove platform count if present)
            const cleanName = stopData.stop_name.replace(/\s*\(\d+\s+platforms\)/, '');
            
            document.getElementById('transportStopId').value = stopData.stop_id;
            document.getElementById('transportStopName').value = cleanName;
            document.getElementById('stopSearchResults').style.display = 'none';
            document.getElementById('transportStopSearch').value = '';
            showSuccess(`Selected stop: ${cleanName}`);
        }
        
        async function testTransportAPI() {
            const stopId = document.getElementById('transportStopId').value;
            const resultDiv = document.getElementById('transportTestResult');
            
            if (!stopId) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Please select a stop first';
                resultDiv.style.display = 'block';
                return;
            }
            
            resultDiv.className = 'test-result';
            resultDiv.textContent = '‚è≥ Testing TRIAS API...';
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch(`/api/test/transport?stop_id=${encodeURIComponent(stopId)}`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `‚úÖ API working! Found ${data.departures.length} departures<br><small>${data.departures.map(d => `Line ${d.line} ‚Üí ${d.direction} at ${d.time}`).join('<br>')}</small>`;
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = `‚ùå API Error: ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Connection error: ${error.message}`;
            }
        }
        
        // Test timetable API
        async function testTimetableAPI() {
            const cohort = document.getElementById('timetableCohort').value.trim();
            const maxItems = parseInt(document.getElementById('timetableMaxItems').value) || 5;
            const resultDiv = document.getElementById('timetableTestResult');
            
            resultDiv.className = 'test-result';
            if (cohort) {
                resultDiv.textContent = `‚è≥ Testing API for cohort: ${cohort}...`;
            } else {
                resultDiv.textContent = '‚è≥ Testing API for all year groups (LAV23, LAV24, LAV25, MAV25)...';
            }
            resultDiv.style.display = 'block';
            
            try {
                // Test without saving config - just call test endpoint
                const params = new URLSearchParams({
                    cohort: cohort,
                    max_items: maxItems
                });
                
                const response = await fetch(`/api/test/timetable?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.lectures && data.lectures.length > 0) {
                        const first = data.lectures[0];
                        const displayName = first.year_group ? `${first.year_group} - ${first.lecture}` : first.lecture;
                        const cohortInfo = cohort ? `for ${cohort}` : 'across all year groups';
                        resultDiv.className = 'test-result success';
                        resultDiv.innerHTML = `‚úÖ <strong>API working!</strong><br>Found ${data.lectures_count} upcoming lecture(s) ${cohortInfo}<br>Next: ${displayName} at ${first.time} (${first.date}) in ${first.room || 'Online'}`;
                    } else {
                        resultDiv.className = 'test-result warning';
                        const cohortInfo = cohort ? `for cohort ${cohort}` : 'for any year group';
                        resultDiv.textContent = `‚ö†Ô∏è ${data.message || 'No upcoming lectures found ' + cohortInfo + ' in the next 14 days.'}`;
                    }
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = `‚ùå API Error: ${data.message || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Connection error: ${error.message}`;
            }
        }
        
        // Search location by city or address
        async function searchLocation() {
            const searchQuery = document.getElementById('locationSearch').value.trim();
            const resultDiv = document.getElementById('locationResult');
            
            if (!searchQuery) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Please enter a city or address to search';
                resultDiv.style.display = 'block';
                return;
            }
            
            resultDiv.className = 'test-result';
            resultDiv.textContent = '‚è≥ Searching for location...';
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchQuery)}&format=json&limit=1`);
                const data = await response.json();
                
                if (data.length === 0) {
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = '‚ùå Location not found. Try a different search term (e.g., "Frankfurt, Germany" or "Frankfurt Airport")';
                    return;
                }
                
                const location = data[0];
                const lat = parseFloat(location.lat).toFixed(4);
                const lon = parseFloat(location.lon).toFixed(4);
                
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lon;
                document.getElementById('locationName').value = location.display_name.split(',')[0];
                
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `‚úÖ Found: ${location.display_name}<br>Coordinates: ${lat}, ${lon}`;
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Search error: ${error.message}`;
            }
        }
        
        // Get current location using browser geolocation
        async function getCurrentLocation() {
            const resultDiv = document.getElementById('locationResult');
            
            if (!navigator.geolocation) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Geolocation is not supported by your browser';
                resultDiv.style.display = 'block';
                return;
            }
            
            resultDiv.className = 'test-result';
            resultDiv.textContent = '‚è≥ Getting your location...';
            resultDiv.style.display = 'block';
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude.toFixed(4);
                    const lon = position.coords.longitude.toFixed(4);
                    
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lon;
                    
                    // Try to get location name using reverse geocoding
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                        const data = await response.json();
                        
                        const locationName = data.address?.city || data.address?.town || data.address?.village || data.address?.state || 'Unknown Location';
                        document.getElementById('locationName').value = locationName;
                        
                        resultDiv.className = 'test-result success';
                        resultDiv.textContent = `‚úÖ Location set to: ${locationName} (${lat}, ${lon})`;
                    } catch (error) {
                        resultDiv.className = 'test-result success';
                        resultDiv.textContent = `‚úÖ Coordinates set to: ${lat}, ${lon} (Could not fetch location name)`;
                    }
                },
                (error) => {
                    resultDiv.className = 'test-result error';
                    let errorMsg = 'Unable to get location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Location permission denied. Please allow location access in your browser.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Location request timed out.';
                            break;
                    }
                    resultDiv.textContent = `‚ùå ${errorMsg}`;
                }
            );
        }
        
        // Password change functions
        function showPasswordModal() {
            const modal = document.getElementById('passwordModal');
            modal.classList.add('show');
        }
        
        function hidePasswordModal() {
            const modal = document.getElementById('passwordModal');
            modal.classList.remove('show');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            console.log('Password change attempt:', {
                currentLen: currentPassword.length,
                newLen: newPassword.length,
                confirmLen: confirmPassword.length,
                match: newPassword === confirmPassword
            });
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showError('All password fields are required');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 4) {
                showError('Password must be at least 4 characters long');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Password changed successfully!');
                    hidePasswordModal();
                } else {
                    showError(data.message || 'Failed to change password');
                }
            } catch (error) {
                showError('Error changing password: ' + error.message);
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }
        
        // Font scale slider update
        document.getElementById('fontScale').addEventListener('input', function(e) {
            const value = parseFloat(e.target.value);
            document.getElementById('fontScaleValue').textContent = Math.round(value * 100) + '%';
        });
        
        // Initialize
        loadConfig();
    </script>
</body>
</html>
