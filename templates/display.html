<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviation Student Information Display</title>
    <style>
        :root {
            --font-scale: 1.0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            font-size: calc(16px * var(--font-scale));
        }
        
        .container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: 1fr auto;
            gap: 15px;
            padding: 0;
            height: 100vh;
        }
        
        .widget {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 0;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow: hidden;
            position: relative;
        }
        
        .widget-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .widget-header .icon {
            font-size: 28px;
        }
        
        /* Header - Time and Date */
        .header {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: transparent;
            backdrop-filter: none;
            padding: 15px 25px;
            border-radius: 0;
        }
        
        .datetime {
            text-align: right;
            background: transparent !important;
            backdrop-filter: none !important;
            box-shadow: none !important;
            border: none !important;
        }
        
        .time {
            font-size: calc(42px * var(--font-scale));
            font-weight: bold;
        }
        
        .date {
            font-size: calc(18px * var(--font-scale));
            opacity: 0.9;
        }
        
        /* Flight Radar */
        .flight-radar {
            grid-row: span 2;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .flight-radar iframe {
            width: 100%;
            flex: 1;
            border: none;
            border-radius: 0;
        }
        
        /* Nearest flights list */
        .nearest-flights {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            margin-top: 15px;
        }
        
        .flight-header {
            display: grid;
            grid-template-columns: 40px 130px 180px 140px 100px 140px 130px 100px;
            align-items: center;
            gap: 15px;
            padding: 6px 12px;
            font-size: calc(11px * var(--font-scale));
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 6px;
        }
        
        .flight-header > div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .flight-item {
            display: grid;
            grid-template-columns: 40px 130px 180px 140px 100px 140px 130px 100px;
            align-items: center;
            gap: 15px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 6px;
            font-size: calc(18px * var(--font-scale));
        }
        
        .flight-item > div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .flight-item:last-child {
            margin-bottom: 0;
        }
        
        .flight-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .flight-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }
        
        .flight-number-col {
            font-weight: bold;
            font-size: calc(20px * var(--font-scale));
        }
        
        .flight-airline-col {
            font-size: calc(18px * var(--font-scale));
            opacity: 0.9;
        }
        
        .flight-route-col {
            font-size: calc(20px * var(--font-scale));
            opacity: 0.9;
        }
        
        .flight-aircraft-col {
            font-size: calc(19px * var(--font-scale));
            opacity: 0.85;
        }
        
        .flight-altitude-col {
            font-size: calc(20px * var(--font-scale));
        }
        
        .flight-speed-col {
            font-size: calc(20px * var(--font-scale));
        }
        
        .flight-distance-col {
            font-size: calc(22px * var(--font-scale));
            font-weight: bold;
            text-align: right;
        }
        
        /* Weather */
        .weather {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .weather-current {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .weather-temp {
            font-size: calc(40px * var(--font-scale));
            font-weight: bold;
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 20px;
            max-width: 320px;
        }
        
        .weather-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: calc(15px * var(--font-scale));
        }
        
        .weather-detail img {
            width: 18px;
            height: 18px;
            opacity: 0.9;
        }
        
        /* Transport */
        .transport {
            overflow-y: auto;
            max-height: 500px;
        }
        
        .transport-header {
            display: grid;
            grid-template-columns: 60px 1fr 80px 70px 60px;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            font-size: calc(11px * var(--font-scale));
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 6px;
        }
        
        .transport-header > div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .timetable-header {
            display: grid;
            grid-template-columns: 110px 1fr 135px;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            font-size: calc(11px * var(--font-scale));
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 6px;
        }
        
        .timetable-header > div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .transport-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .transport-item {
            display: grid;
            grid-template-columns: 60px 1fr 80px 70px 60px;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0;
            font-size: calc(18px * var(--font-scale));
        }
        
        .transport-item > span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .transport-line {
            font-weight: bold;
            font-size: calc(20px * var(--font-scale));
        }
        
        .transport-direction {
            font-size: calc(18px * var(--font-scale));
            opacity: 0.9;
        }
        
        .transport-countdown {
            font-size: calc(18px * var(--font-scale));
            text-align: right;
        }
        
        .transport-time {
            font-size: calc(20px * var(--font-scale));
            font-weight: bold;
            text-align: right;
        }
        
        .transport-status {
            font-size: calc(11px * var(--font-scale));
            padding: 3px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-align: center;
        }
        
        .transport-status.live {
            background: rgba(255, 68, 68, 0.3);
            color: #fff;
        }
        
        .transport-status.planned {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Timetable */
        .timetable {
            grid-column: 1 / -1;
            overflow-y: auto;
            max-height: 350px;
        }
        
        .timetable-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .timetable-item {
            display: grid;
            grid-template-columns: 80px 1fr 135px;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0;
            font-size: calc(18px * var(--font-scale));
        }
        
        .timetable-item.now {
            background: rgba(255, 152, 0, 0.2);
            border-left: 3px solid #ff9800;
        }
        
        .timetable-item.exam {
            background: rgba(220, 53, 69, 0.15);
            border-left: 3px solid #dc3545;
        }
        
        .timetable-item.exam.now {
            background: rgba(255, 152, 0, 0.3);
            border-left: 3px solid #ff9800;
        }
        
        .timetable-time {
            font-weight: bold;
            font-size: calc(20px * var(--font-scale));
            overflow: visible;
        }
        
        .timetable-course {
            font-size: calc(18px * var(--font-scale));
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .timetable-room {
            font-size: calc(17px * var(--font-scale));
            opacity: 0.85;
            text-align: right;
            overflow: visible !important;
            text-overflow: clip !important;
            white-space: normal !important;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- Floating Time/Date Header -->
    <div class="header">
        <div class="datetime">
            <div class="time" id="time">00:00:00</div>
            <div class="date" id="date">Loading...</div>
        </div>
    </div>
    
    <div class="container">
        <!-- Flight Radar -->
        <div class="widget flight-radar">
            <iframe id="flight-radar" src="about:blank"></iframe>
            
            <!-- Nearest Flights List -->
            <div class="nearest-flights" id="nearest-flights">
                <div style="font-size: 14px; opacity: 0.7;">Loading nearest flights...</div>
            </div>
        </div>
        
        <!-- Weather -->
        <div class="widget weather">
            <div class="weather-current">
                <div class="weather-icon" id="weather-icon" style="font-size: 50px;">üå§Ô∏è</div>
                <div>
                    <div class="weather-temp" id="weather-temp">--¬∞C</div>
                    <div id="weather-condition" style="font-size: 16px; opacity: 0.9;">Loading...</div>
                </div>
            </div>
            <div class="weather-details">
                <div class="weather-detail">
                    <img src="/static/icons/wind.svg" alt="wind">
                    <span id="weather-wind">-- km/h</span>
                </div>
                <div class="weather-detail">
                    <img src="/static/icons/rain.svg" alt="humidity">
                    <span id="weather-humidity">--%</span>
                </div>
                <div class="weather-detail">
                    <img src="/static/icons/temperature.svg" alt="temperature">
                    <span id="weather-pressure">-- hPa</span>
                </div>
                <div class="weather-detail">
                    <img src="/static/icons/visibility.svg" alt="visibility">
                    <span id="weather-visibility">-- km</span>
                </div>
            </div>
            
            <!-- Transport integrated into weather widget -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.2);">
                <div class="widget-header" style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span id="transport-title">Next Departures</span>
                    <span id="transport-status" style="font-size: 12px; padding: 3px 8px; border-radius: 3px; background: rgba(40, 167, 69, 0.3); color: #fff;">‚óè</span>
                </div>
                <div class="transport-header">
                    <div>Line</div>
                    <div>Destination</div>
                    <div>In</div>
                    <div>Time</div>
                    <div>Status</div>
                </div>
                <div class="transport-list" id="transport-list">
                    <div class="transport-item">
                        <div>
                            <div class="transport-line">Loading...</div>
                            <div style="font-size: 14px; margin-top: 5px;">Please wait</div>
                        </div>
                        <div class="transport-time">--</div>
                    </div>
                </div>
            </div>
            
            <!-- Timetable integrated into weather widget -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.2);">
                <div class="widget-header" style="margin-bottom: 10px;">
                    <span>Next Lectures</span>
                </div>
                <div class="timetable-header">
                    <div>Time</div>
                    <div>Course</div>
                    <div>Room</div>
                </div>
                <div class="timetable-list" id="timetable-list">
                    <div class="transport-item">
                        <span>--:--</span>
                        <span>Loading...</span>
                        <span>---</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration - will be loaded from server
        let config = {
            location: { lat: 0, lon: 0 },
            flightRadarUrl: '',
            weatherApiKey: '',
            transportStop: '',
            timetable: []
        };
        let lastModified = null;
        
        // Update time and date
        function updateDateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            const dateStr = now.toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('time').textContent = timeStr;
            document.getElementById('date').textContent = dateStr;
        }
        
        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/dashboard/config');
                const data = await response.json();
                if (data.success) {
                    config = data.config;
                    lastModified = config.last_modified;
                    
                    // Apply font scale
                    const fontScale = config.display?.font_scale || 1.0;
                    document.documentElement.style.setProperty('--font-scale', fontScale);
                    
                    resetServerError(); // Server is responding
                    initializeDashboard();
                }
            } catch (error) {
                console.error('Failed to load config:', error);
                handleServerError();
            }
        }
        
        // Check if config has been updated and reload if needed
        async function checkForUpdates() {
            try {
                const response = await fetch('/api/dashboard/config');
                const data = await response.json();
                if (data.success && data.config.last_modified) {
                    if (lastModified && data.config.last_modified !== lastModified) {
                        console.log('Configuration updated, reloading page...');
                        location.reload();
                    }
                }
            } catch (error) {
                console.error('Failed to check for updates:', error);
                // Server might be down or restarting, schedule a reload check
                handleServerError();
            }
        }
        
        // Handle server connectivity issues (restarts, updates)
        let serverErrorCount = 0;
        let reconnectInterval = null;
        
        function handleServerError() {
            serverErrorCount++;
            
            // After 2 consecutive errors, start trying to reconnect
            if (serverErrorCount >= 2 && !reconnectInterval) {
                console.log('Server appears to be down, attempting to reconnect...');
                reconnectInterval = setInterval(async () => {
                    try {
                        const response = await fetch('/api/dashboard/config');
                        if (response.ok) {
                            console.log('Server is back online, reloading page...');
                            location.reload();
                        }
                    } catch (error) {
                        console.log('Still waiting for server...');
                    }
                }, 3000); // Check every 3 seconds when server is down
            }
        }
        
        // Reset error counter on successful requests
        function resetServerError() {
            serverErrorCount = 0;
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
            }
        }
        
        // Initialize dashboard
        function initializeDashboard() {
            loadFlightRadar();
            loadWeather();
            loadTransport();
            loadTimetable();
            loadNearestFlights();
        }
        
        // Load flight radar
        function loadFlightRadar() {
            const iframe = document.getElementById('flight-radar');
            const lat = config.location?.lat || 50.0;
            const lon = config.location?.lon || 8.0;
            // Using embed parameters to minimize UI
            iframe.src = `https://globe.adsbexchange.com/?icao=~&lat=${lat}&lon=${lon}&zoom=8.5&enableLabels&extendedLabels=1&trackLabels&SiteLat=${lat}&SiteLon=${lon}&hideSidebar&hideButtons`;
        }
        
        // Load nearest flights
        async function loadNearestFlights() {
            try {
                const response = await fetch('/api/dashboard/nearest-flights');
                const data = await response.json();
                
                if (data.success && data.flights && data.flights.length > 0) {
                    const container = document.getElementById('nearest-flights');
                    container.style.display = 'block';
                    container.innerHTML = `
                        <div class="flight-header">
                            <div></div>
                            <div>Flight</div>
                            <div>Airline</div>
                            <div>Route</div>
                            <div>Aircraft</div>
                            <div>Altitude</div>
                            <div>Speed</div>
                            <div>Distance</div>
                        </div>
                        ${data.flights.map(flight => {
                            // Build route display - show nothing if both are empty
                            let routeDisplay = '';
                            if (flight.from && flight.to) {
                                routeDisplay = `${flight.from} ‚Üí ${flight.to}`;
                            } else if (flight.from) {
                                routeDisplay = `${flight.from} ‚Üí `;
                            } else if (flight.to) {
                                routeDisplay = ` ‚Üí ${flight.to}`;
                            }
                            
                            // Format altitude - don't show "ft" for ground
                            let altitudeDisplay = flight.altitude;
                            if (String(flight.altitude).toLowerCase() !== 'ground') {
                                altitudeDisplay = `${flight.altitude} ft`;
                            }
                            
                            return `
                            <div class="flight-item">
                                <div class="flight-icon">
                                    <img src="/static/icons/${flight.aircraft_category || 'unknown'}.svg" alt="${flight.aircraft_category || 'aircraft'}">
                                </div>
                                <div class="flight-number-col">${flight.flight_number || flight.callsign}</div>
                                <div class="flight-airline-col">${flight.airline_name || flight.airline || ''}</div>
                                <div class="flight-route-col">${routeDisplay}</div>
                                <div class="flight-aircraft-col">${flight.aircraft_type || ''}</div>
                                <div class="flight-altitude-col">${altitudeDisplay}</div>
                                <div class="flight-speed-col">${flight.speed} kts</div>
                                <div class="flight-distance-col">${flight.distance} km</div>
                            </div>
                            `;
                        }).join('')}
                    `;
                } else {
                    // Hide the nearest flights section when not available
                    const container = document.getElementById('nearest-flights');
                    if (container) {
                        container.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to load nearest flights:', error);
                // Hide on error
                const container = document.getElementById('nearest-flights');
                if (container) {
                    container.style.display = 'none';
                }
            }
        }
        
        // Load weather
        async function loadWeather() {
            try {
                const response = await fetch('/api/dashboard/weather');
                const data = await response.json();
                
                if (data.success) {
                    const w = data.weather;
                    document.getElementById('weather-temp').textContent = `${Math.round(w.temp)}¬∞C`;
                    document.getElementById('weather-condition').textContent = w.description;
                    document.getElementById('weather-wind').textContent = `${w.wind} km/h`;
                    document.getElementById('weather-humidity').textContent = `${w.humidity}%`;
                    document.getElementById('weather-pressure').textContent = `${w.pressure} hPa`;
                    document.getElementById('weather-visibility').textContent = `${w.visibility} km`;
                    document.getElementById('weather-icon').textContent = getWeatherIcon(w.icon);
                }
            } catch (error) {
                console.error('Failed to load weather:', error);
            }
        }
        
        // Get weather icon
        function getWeatherIcon(code) {
            const icons = {
                '01d': '‚òÄÔ∏è', '01n': 'üåô',
                '02d': '‚õÖ', '02n': '‚òÅÔ∏è',
                '03d': '‚òÅÔ∏è', '03n': '‚òÅÔ∏è',
                '04d': '‚òÅÔ∏è', '04n': '‚òÅÔ∏è',
                '09d': 'üåßÔ∏è', '09n': 'üåßÔ∏è',
                '10d': 'üå¶Ô∏è', '10n': 'üåßÔ∏è',
                '11d': '‚õàÔ∏è', '11n': '‚õàÔ∏è',
                '13d': 'üå®Ô∏è', '13n': 'üå®Ô∏è',
                '50d': 'üå´Ô∏è', '50n': 'üå´Ô∏è'
            };
            return icons[code] || 'üå§Ô∏è';
        }
        
        // Load transport
        async function loadTransport() {
            const statusIndicator = document.getElementById('transport-status');
            try {
                const response = await fetch('/api/dashboard/transport');
                const data = await response.json();
                
                if (data.success && data.departures.length > 0) {
                    const list = document.getElementById('transport-list');
                    
                    // Update connection status to green (connected)
                    statusIndicator.style.background = 'rgba(40, 167, 69, 0.3)';
                    statusIndicator.style.color = '#28a745';
                    statusIndicator.textContent = '‚óè';
                    statusIndicator.title = 'Connected - Data is current';
                    
                    // Update title with stop name if available
                    if (data.stop_name) {
                        document.getElementById('transport-title').textContent = `Next Departures ${data.stop_name}`;
                    }
                    
                    // Function to calculate countdown
                    const getCountdown = (timestamp) => {
                        const now = new Date();
                        const departure = new Date(timestamp);
                        const diffMs = departure - now;
                        const diffMins = Math.floor(diffMs / 60000);
                        
                        if (diffMins < 0) return 'now';
                        if (diffMins === 0) return 'now';
                        if (diffMins < 60) return diffMins + 'm';
                        const hours = Math.floor(diffMins / 60);
                        const mins = diffMins % 60;
                        return hours + 'h ' + mins + 'm';
                    };
                    
                    // Function to get mode icon
                    const getModeIcon = (mode) => {
                        const m = mode.toLowerCase();
                        if (m.includes('tram')) return 'Tram';
                        if (m.includes('bus')) return 'Bus';
                        if (m.includes('train') || m.includes('rail')) return 'Train';
                        if (m.includes('metro') || m.includes('subway')) return 'Metro';
                        return 'Bus'; // default to bus
                    };
                    
                    list.innerHTML = data.departures.map(dep => `
                        <div class="transport-item">
                            <span class="transport-line">${dep.line}</span>
                            <span class="transport-direction">${dep.direction}</span>
                            <span class="transport-countdown">${getCountdown(dep.timestamp)}</span>
                            <span class="transport-time">${dep.time}</span>
                            <span class="transport-status ${dep.is_realtime ? 'live' : 'planned'}">
                                ${dep.is_realtime ? 'live' : 'plan'}
                            </span>
                        </div>
                    `).join('');
                } else {
                    // API returned success but no data
                    statusIndicator.style.background = 'rgba(255, 193, 7, 0.3)';
                    statusIndicator.style.color = '#ffc107';
                    statusIndicator.textContent = '‚óè';
                    statusIndicator.title = 'No departure data available';
                }
            } catch (error) {
                console.error('Failed to load transport:', error);
                // Update connection status to red (disconnected/error)
                const statusIndicator = document.getElementById('transport-status');
                statusIndicator.style.background = 'rgba(220, 53, 69, 0.3)';
                statusIndicator.style.color = '#dc3545';
                statusIndicator.textContent = '‚óè no connection';
                statusIndicator.title = 'Connection error - Data may be outdated';
            }
        }
        
        // Load timetable
        async function loadTimetable() {
            try {
                const response = await fetch('/api/dashboard/timetable');
                const data = await response.json();
                
                if (data.success && data.lectures.length > 0) {
                    const list = document.getElementById('timetable-list');
                    const now = new Date();
                    
                    list.innerHTML = data.lectures.map(lecture => {
                        // Check if lecture is happening now (within 30 minutes)
                        const lectureTime = new Date(lecture.timestamp);
                        const diffMins = Math.floor((lectureTime - now) / 60000);
                        const isNow = diffMins >= 0 && diffMins < 30;
                        const isExam = lecture.type === 'EXAM';
                        
                        // Format display: "LAV23 - Lecture Name" (no EXAM prefix)
                        let displayText = '';
                        if (lecture.year_group) {
                            displayText = `${lecture.year_group} - ${lecture.lecture}`;
                        } else {
                            displayText = lecture.lecture;
                        }
                        
                        // Build class list
                        const classes = ['timetable-item'];
                        if (isNow) classes.push('now');
                        if (isExam) classes.push('exam');
                        
                        return `
                            <div class="${classes.join(' ')}">
                                <span class="timetable-time">${lecture.time}</span>
                                <span class="timetable-course">${displayText}</span>
                                <span class="timetable-room">${lecture.room || 'Online'}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    // Show empty state
                    const list = document.getElementById('timetable-list');
                    list.innerHTML = `
                        <div class="timetable-item">
                            <span>--:--</span>
                            <span>No lectures</span>
                            <span>---</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load timetable:', error);
            }
        }
        
        // Initialize
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        loadConfig();
        
        // Refresh data periodically
        setInterval(loadWeather, 300000); // 5 minutes
        setInterval(loadTransport, 60000); // 1 minute
        setInterval(loadTimetable, 60000); // 1 minute
        setInterval(loadNearestFlights, 15000); // 15 seconds - cached routes prevent rate limiting
        setInterval(checkForUpdates, 3000); // Check for config updates every 3 seconds (fast response to admin changes)
    </script>
</body>
</html>
